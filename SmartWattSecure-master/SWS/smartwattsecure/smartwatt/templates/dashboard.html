{% extends "base.html" %} {% load static %} {% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Smart Watt Secure</title>
    <link rel="stylesheet" href="{% static 'css/db.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/db.js' %}"></script>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="dashboard-page">
    <!-- Main Content Section -->
    <section class="main-content">
      <div class="main-header">
        {% if user.is_authenticated %}
        <h1>Welcome, {{ user.username }}!</h1>
        {% else %}
        <p>You are not logged in.</p>
        {% endif %}
      </div>
    </section>

    <!-- Light Image Below Header -->
    <div class="light-image-container">
      <img
        src="{% static 'img/bg/shape-1-4.png' %}"
        alt="Hanging Light"
        class="light-image"
      />
    </div>

    <div class="container-fluid mt-4">
      <div class="row">
        <div
          class="col-md-6 left-section background-image content"
          style="background-image: url('{% static 'img/bg/lines.png' %}')"
        >
          <div class="row">
            <!-- Units Box -->
            <div class="col-md-6 info-box custom-div">
              <div class="label">Units</div>
              <p><span id="total-units"></span> kWh</p>
            </div>
            <!-- Current Box -->
            <div class="col-md-6 info-box custom-div">
              <div class="label">Current</div>
              <p><span id="current"></span> A</p>
            </div>
          </div>
          <div class="row mt-3">
            <!-- Voltage Box -->
            <div class="col-md-6 info-box custom-div">
              <div class="label">Voltage</div>
              <p><span id="voltage"></span> V</p>
            </div>
            <!-- Frequency Box -->
            <div class="col-md-6 info-box custom-div">
              <div class="label">Anomalies</div>
              <p><span id="frequency"></span> --</p>
            </div>
          </div>
        </div>

        <!-- Graph Section -->
        <div class="col-md-6 right-section">
          <div class="card shadow-sm">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5>Units Consumption Chart</h5>
              <div>
                <label for="time-filter" class="form-label me-2"
                  >View by:</label
                >
                <select
                  id="time-filter"
                  class="form-select form-select-sm d-inline-block"
                  style="width: auto"
                >
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="monthly">Yearly</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="chart-wrapper">
                <div class="chart-container">
                  <canvas id="unitsConsumedChart"></canvas>
                </div>
              </div>
            </div>
            <div class="card-footer text-end">
              <button id="download-pdf" class="btn btn-danger">
                <span>Download PDF</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document
        .getElementById("download-pdf")
        .addEventListener("click", async () => {
          const { jsPDF } = window.jspdf;

          // Select the chart element to capture
          const chartElement = document.getElementById("unitsConsumedChart");

          // Capture the chart as a canvas using html2canvas
          const canvas = await html2canvas(chartElement);
          const imgData = canvas.toDataURL("image/png");

          // Initialize jsPDF
          const pdf = new jsPDF("landscape");

          // Add the image of the chart to the PDF
          pdf.addImage(imgData, "PNG", 10, 10, 270, 150); // Position and size of the image in the PDF

          // Download the PDF with a custom filename
          pdf.save("Units_Consumption_Chart.pdf");
        });

      let chart; // Declare chart globally

      // Function to fetch weekly data from the API
      async function getWeeklyData() {
        try {
          const response = await fetch("/api/weekly_data/");
          if (!response.ok) {
            throw new Error("Failed to fetch weekly data");
          }
          const data = await response.json();

          const formattedLabels = data.labels.map(
            (date) => new Date(date).toLocaleDateString() // Format the date
          );

          return {
            labels: formattedLabels,
            datasets: [
              {
                label: "Weekly Units Consumed",
                data: data["units consumed"],
                borderColor: "#DD0733", // Line color
                backgroundColor: "rgba(221, 7, 51, 0.2)", // Transparent fill under the line
                borderWidth: 2,
                fill: true,
              },
            ],
          };
        } catch (error) {
          console.error("Error fetching weekly data:", error);
          return {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [
              {
                label: "Weekly Units Consumed",
                data: [0, 0, 0, 0, 0, 0, 0],
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          };
        }
      }

      // Function to render the chart
      async function renderChart() {
        const chartData = await getWeeklyData();

        // Initialize the chart
        const ctx = document
          .getElementById("unitsConsumedChart")
          .getContext("2d");
        chart = new Chart(ctx, {
          type: "line", // Area chart (Line chart with fill)
          data: chartData,
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                min: 0,
                max: 20,
                ticks: {
                  stepSize: 4,
                },
                title: {
                  display: true,
                  text: "Units Consumed",
                },
              },
            },
          },
        });

        startChartUpdates(); // Start updates after chart is initialized
      }

      // Function to start periodic updates
      function startChartUpdates() {
        if (!chart) {
          console.error("Chart is not initialized. Cannot start updates.");
          return;
        }

        setInterval(async () => {
          const updatedData = await getWeeklyData();
          chart.data.labels = updatedData.labels;
          chart.data.datasets[0].data = updatedData.datasets[0].data;
          chart.update(); // Redraw the chart with new data
        }, 2000);
      }

      // Render the chart when the page is loaded
      window.onload = renderChart;

      // Fetch the latest data using AJAX
      function fetchData() {
        fetch("/api/energy_data/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            // Update UI elements
            document.getElementById("voltage").innerText = `${
              data.voltage || 0
            }`;
            document.getElementById("current").innerText = `${
              data.current || 0
            }`;
            document.getElementById("total-units").innerText = `${
              data.total_units_since_midnight || 0
            }`;
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      }

      setInterval(fetchData, 2000);
    </script>
  </body>
</html>
{% endblock %}
