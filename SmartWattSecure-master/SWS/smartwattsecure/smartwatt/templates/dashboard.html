{% extends "base.html" %} {% load static %} {% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Smart Watt Secure</title>
    <link rel="stylesheet" href="{% static 'css/db.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/db.js' %}"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Main Content Section -->
    <section class="main-content">
      <div class="main-header">
        {% if user.is_authenticated %}
        <h1>Welcome, {{ user.username }}!</h1>
        {% else %}
        <p>You are not logged in.</p>
        {% endif %}
      </div>
    </section>

    <!-- Light Image Below Header -->
    <div class="light-image-container">
      <img
        src="{% static 'img/bg/shape-1-4.png' %}"
        alt="Hanging Light"
        class="light-image"
      />
    </div>

    <div class="container-fluid mt-4">
      <div class="row">
        <!-- Left Side Divs -->
        <div
          class="col-md-6 left-section background-image content"
          style="background-image: url('{% static 'img/bg/lines.png' %}')"
        >
          <div class="d-flex flex-wrap align-items-start">
            <!-- Units Box -->
            <div class="info-box custom-div me-3 mb-3">
              <div class="label">Units</div>
              <p><span id="total-units"></span>kWh</p>
              
            </div>
            <!-- Current Box -->
            <div class="info-box custom-div mb-3">
              <div class="label">Current</div>
              <p><span id="current"></span>A</p>
            </div>
            <!-- Voltage Box -->
            <div class="info-box custom-div mt-3">
              <div class="label">Voltage</div>
              <p><span id="voltage"></span>V</p>
              <canvas
                id="voltageGraph"
                style="width: 100%; height: 70px"
              ></canvas>
            </div>
          </div>
        </div>

        <!-- Graph Section -->
        <div class="col-md-6 right-section">
          <div class="card shadow-sm">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5>Units Consumption Chart</h5>
              <div>
                <label for="time-filter" class="form-label me-2"
                  >View by:</label
                >
                <select
                  id="time-filter"
                  class="form-select form-select-sm d-inline-block"
                  style="width: auto"
                >
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="chart-wrapper">
                <div class="chart-container">
                  <canvas id="unitsConsumedChart"></canvas>
                </div>
              </div>
            </div>
            <div class="card-footer text-end">
              <button id="download-pdf" class="btn btn-danger">
                <span>Download PDF</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Fetch the latest data using AJAX
      function fetchData() {
        fetch("/api/energy_data/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
                // Update UI elements
                document.getElementById("voltage").innerText = `${data.voltage || 0}`;
                document.getElementById("current").innerText = `${data.current || 0}`;
                document.getElementById("total-units").innerText = `${data.total_units_since_midnight || 0}`;
          })
          .catch((error) => {
                console.error("Fetch error:", error);
          });
      }


      setInterval(fetchData, 2000);
    </script>
  </body>
</html>
{% endblock %}
