{% extends "base.html" %} {% load static %} {% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - Smart Watt Secure</title>
    <link rel="stylesheet" href="{% static 'css/ana.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/ana.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="analytics-container row">
      <div
        class="col-md-6 left-section background-image content"
        style="background-image: url('{% static 'img/bg/shape-2-1.png' %}')"
      ></div>
      <!-- Graph Section -->
      <div class="graph-section">
        <div class="card shadow-sm">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5>Anomalies Chart</h5>
            <div>
              <label for="time-filter" class="form-label me-2">View by:</label>
              <select
                id="time-filter"
                class="form-select form-select-sm d-inline-block"
                style="width: auto"
              >
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-wrapper">
              <div class="chart-container">
                <canvas id="anomaliesChart"></canvas>
              </div>
            </div>
          </div>
          <div class="card-footer text-end">
            <button id="download-pdf" class="btn btn-danger">
              <span>Download PDF</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Notifications Section -->
      <div class="notification-section">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5>Notifications</h5>
          </div>
          <div class="card-body notification-content"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const notificationContent = document.querySelector(
          ".notification-content"
        );

        // Fetch notifications from the server
        fetch("/get_notifications/")
          .then((response) => response.json())
          .then((data) => {
            // Clear existing notifications
            notificationContent.innerHTML = "";

            // Populate notifications dynamically
            data.forEach((notification) => {
              const notificationItem = document.createElement("p");
              notificationItem.textContent = `${notification.date} - ${notification.message}`;
              notificationContent.appendChild(notificationItem);
            });
          })
          .catch((error) => {
            console.error("Error fetching notifications:", error);
          });
      });

      async function fetchAndUpdateAnomalies(chart) {
        try {
          const response = await fetch("/get_latest_anomalies/");
          if (!response.ok) throw new Error("Failed to fetch anomalies");
          const data = await response.json();

          // Update chart data
          chart.data.labels = data.labels;
          chart.data.datasets[0].data = data.anomalies;

          // Re-render the chart
          chart.update();
        } catch (error) {
          console.error("Error fetching anomalies:", error);
        }
      }

      const ctx = document.getElementById("anomaliesChart").getContext("2d");

      // Fetch anomaly data and render chart
      fetch("/get_anomalies/") // API endpoint to fetch anomalies
        .then((response) => response.json())
        .then((data) => {
          // Format labels (dates) for the x-axis
          const formattedLabels = data.labels.map((date) =>
            new Date(date).toLocaleDateString()
          );

          // Map anomaly dates to counts for each day
          const anomalyCounts = data.anomalies;
          // Create the chart
          const anomaliesChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: formattedLabels, // Last 7 days
              datasets: [
                {
                  label: "Weekly Anomalies",
                  data: anomalyCounts, // Anomaly counts for each day
                  borderColor: "#DD0733",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true, position: "top" },
              },
              scales: {
                x: {
                  title: { display: true, text: "Days" },
                },
                y: {
                  title: { display: true, text: "Anomalies Detected" },
                  min: 0,
                  max: 25,
                },
              },
            },
          });
        })
        .catch((error) => {
          console.error("Error fetching anomalies:", error);
        });
    </script>
  </body>
</html>
{% endblock %}
